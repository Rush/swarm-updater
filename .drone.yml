kind: pipeline
name: default

steps:
- name: test
  image: golang:1.11
  commands:
  - go install golang.org/x/lint/golint
  - go vet ./...
  - go test -v ./...
  - golint -set_exit_status `find . -type d -not -path "./vendor*" -not -path "./.git*"`
  settings:
    environment:
    - GO111MODULE=on
    - GOFLAGS=-mod=vendor

- name: build
  image: plugins/docker
  settings:
    repo: registry.megpoid.xyz/swarm-updater
    tags: latest
    registry: registry.megpoid.xyz
    mirror: http://mirror:5000
    build_args:
      - BUILD_NUMBER=${DRONE_BUILD_NUMBER}
      - BUILD_COMMIT_SHORT=${DRONE_COMMIT_SHA:0:8}
      - IMAGE_NAME=registry.megpoid.xyz/swarm-updater
    username: megpoid
    password:
      from_secret: docker_password

- name: dockerhub
  image: plugins/docker
  settings:
    repo: codestation/swarm-updater
    tags: latest
    mirror: http://mirror:5000
    build_args:
      - BUILD_NUMBER=${DRONE_BUILD_NUMBER}
      - BUILD_COMMIT_SHORT=${DRONE_COMMIT_SHA:0:8}
    username: codestation
    password:
      from_secret: dockerhub_password

trigger:
  branch:
  - master
